@(results: List[models.TaxYearResults], selectedYears: Array[Int])(implicit request:Request[_])

@analyticsAdditionalJs = {
  ga('set', {
    title: "@Messages("paac.results.page.title")",
    language: 'en-gb',
  });
  @results.map { result =>
    @if(result.summaryResult.chargableAmount > 0) {
ga('send', 'event', 'Calculation', 'Result: Tax', '@result.input.taxYearLabel', @(result.summaryResult.taxBucket),{nonInteraction: true});
    }
    @if(result.summaryResult.isACA) {
ga('send', 'event', 'Calculation', 'Result: ACA', '@result.input.taxYearLabel', {nonInteraction: true});
ga('send', 'event', 'Calculation', 'Result: AAA', '@result.input.taxYearLabel', @(result.summaryResult.aaaBucket),{nonInteraction: true});
      @if(result.summaryResult.unusedAAABucket> 0) {
ga('send', 'event', 'Calculation', 'Result: AAA Unused', '@result.input.taxYearLabel', @(result.summaryResult.unusedAAABucket),{nonInteraction: true});
      }
    } else {
ga('send', 'event', 'Calculation', 'Result: DCA', '@result.input.taxYearLabel', {nonInteraction: true});
ga('send', 'event', 'Calculation', 'Result: AA', '@result.input.taxYearLabel', @(result.summaryResult.aaBucket),{nonInteraction: true});
ga('send', 'event', 'Calculation', 'Result: AA Unused', '@result.input.taxYearLabel', @(result.summaryResult.unusedAABucket),{nonInteraction: true});
    }

    @if(result.input.amounts.isDefined){
      @defining(result.input.amounts.get) { a =>

        @if(a.definedBenefit.isDefined && !result.input.isTriggered) {
ga('send', 'event', 'Calculation', 'Input: DB', '@result.input.taxYearLabel', @(a.definedBenefitBucket),{nonInteraction: true});
        }

        @if(a.moneyPurchase.isDefined && !result.input.isTriggered) {
ga('send', 'event', 'Calculation', 'Input: DC', '@result.input.taxYearLabel', @(a.moneyPurchaseBucket),{nonInteraction: true});
        }

        @if(a.moneyPurchase.isDefined && result.input.isTriggered) {
ga('send', 'event', 'Calculation', 'Input: Flexi DC', '@result.input.taxYearLabel', @(a.moneyPurchaseBucket),{nonInteraction: true});
        }

        @if(a.income.isDefined && !result.input.isTriggered) {
ga('send', 'event', 'Calculation', 'Input: AI', '@result.input.taxYearLabel', @(a.incomeBucket),{nonInteraction: true});
        }
      }
    }

  @if(result.input.taxPeriodStart.taxYear >= 2015) {
ga('send', 'event', 'Calculation', 'Input: Flexi Access Event', '@result.input.taxYearLabel', @if(result.input.isTriggered){1}else{0},{nonInteraction: true});
  }
  }
ga('send', 'event', 'paac', 'page view', '@Messages("paac.results.page.title")',{nonInteraction: true});
}

@common.paacMain(
pageTitle = Messages("paac.results.page.title"),
heading = Messages("paac.results.page.heading"),
mainClass = "main",
articleClasses=Some("full-width"),
backLink = Some((controllers.routes.ReviewTotalAmountsController.onPageLoad.url,Messages("paac.link.text.back"))),
analyticsAdditionalJs = Some(analyticsAdditionalJs)
) {
@defining(java.text.NumberFormat.getNumberInstance(java.util.Locale.UK)) { currencyFormatter =>
@defining(results.sortWith(_.input.taxPeriodStart.year < _.input.taxPeriodStart.year).dropWhile((v)=>v.input.isEmpty).reverse.filter((c)=>selectedYears.contains(c.input.taxPeriodStart.year))) { sortedResults =>
@defining(sortedResults.exists((data) => data.summaryResult.isMPA)){ mpaaPresent =>

@defining(sortedResults.headOption.getOrElse(TaxYearResults()).input.taxPeriodStart.year == 2015){ year1516 =>
  @defining(sortedResults.take(2).map(_.summaryResult.chargableAmount).foldLeft(0L)(_+_)) { year2015Tax =>
    @defining(sortedResults.headOption.getOrElse(TaxYearResults()).summaryResult.chargableAmount) { tax =>
      @if(year1516 && year2015Tax > 0){
      <p class="govuk-box-highlight lede">@Html(Messages("paac.results.p1", currencyFormatter.format(year2015Tax/100)))</p>
      } else {
          @if(!year1516 && tax > 0) {
             <p class="govuk-box-highlight lede">@Html(Messages("paac.results.p1", currencyFormatter.format(tax/100)))</p>
          } else {
             <p class="govuk-box-highlight lede">@Html(Messages("paac.results.p2",
                currencyFormatter.format(sortedResults.headOption.getOrElse(TaxYearResults()).summaryResult.availableAAWithCCF/100)))</p>
          }
      }

      <table>
       <thead>
       <tr>
         <th scope="col">@Html(Messages("paac.results.table.col.1"))</th>
         <th class="numeric" scope="col">@Html(Messages("paac.results.table.col.2"))</th>
         @if(mpaaPresent){
           <th class="numeric" scope="col">@Html(Messages("paac.results.table.col.3"))</th>
         }
         <th class="numeric" scope="col">@Html(Messages("paac.results.table.col.4"))</th>
         <th class="numeric" scope="col">@Html(Messages("paac.results.table.col.5"))</th>
         <th class="numeric" scope="col">@Html(Messages("paac.results.table.col.6"))</th>
       </tr>
       </thead>
       <tbody>

    @sortedResults.map { result =>
      @if(result.input.amounts.isDefined && !result.input.isPeriod1 && !result.input.isPeriod2) {
       <tr>
          <td>@Messages("paac.results.taxyearlabel", result.input.taxPeriodStart.year.toString, (result.input.taxPeriodStart.year+1).toString)</td>
          <td class="numeric">
            @if(result.summaryResult.isACA) {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAAWithCF/100))
            } else {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAWithCF/100))
            }
          </td>
          @if(mpaaPresent){
            <td class="numeric">
                @if(result.input.taxPeriodStart.year >= 2015){
                  &pound;@(currencyFormatter.format(result.summaryResult.moneyPurchaseAA/100))
                } else { N/A }
            </td>
          }
          <td class="numeric">&pound;@(currencyFormatter.format((result.input.amounts.get.definedBenefit.getOrElse(0L) + result.input.amounts.get.moneyPurchase.getOrElse(0L))/100))</td>
          <td class="numeric">&pound;@(currencyFormatter.format(result.summaryResult.chargableAmount/100))</td>
          <td class="numeric">&pound;@if(result.summaryResult.isACA) {@(currencyFormatter.format(result.summaryResult.availableAAAWithCCF/100))}else{@(currencyFormatter.format(result.summaryResult.availableAAWithCCF/100))}
          </td>
       </tr>
      }
      @if(result.input.amounts.isDefined && result.input.isPeriod1) {
       <tr>
          <td>@Messages("paac.results.taxyearlabel.p1")</td>
          <td class="numeric">
            @if(result.summaryResult.isACA) {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAAWithCF/100))
            } else {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAWithCF/100))
            }
          </td>
          @if(mpaaPresent){
            <td class="numeric">&pound;@(currencyFormatter.format(result.summaryResult.moneyPurchaseAA/100))</td>
          }
          <td class="numeric">&pound;@(currencyFormatter.format((result.input.amounts.get.definedBenefit.getOrElse(0L) +
                                                                result.input.amounts.get.moneyPurchase.getOrElse(0L))
                                                                /100))</td>
          <td class="numeric">&pound;@(currencyFormatter.format((result.summaryResult.chargableAmount)/100))</td>
          <td class="numeric">&pound;@if(result.summaryResult.isACA) {@(currencyFormatter.format(result.summaryResult.availableAAAWithCCF/100))}else{@(currencyFormatter.format(result.summaryResult.availableAAWithCCF/100))}
          </td>
       </tr>
      }
      @if(result.input.amounts.isDefined && result.input.isPeriod2) {
       <tr>
          <td>@Messages("paac.results.taxyearlabel.p2")</td>
          <td class="numeric">
            @if(result.summaryResult.isACA) {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAAWithCF/100))
            } else {
              &pound;@(currencyFormatter.format(result.summaryResult.availableAAWithCF/100))
            }
          </td>
          @if(mpaaPresent){
            <td class="numeric">&pound;@(currencyFormatter.format(result.summaryResult.moneyPurchaseAA/100))</td>
          }
          <td class="numeric">&pound;@(currencyFormatter.format((result.input.amounts.get.definedBenefit.getOrElse(0L) +
                                                                result.input.amounts.get.moneyPurchase.getOrElse(0L))/100))</td>
          <td class="numeric">&pound;@(currencyFormatter.format((result.summaryResult.chargableAmount)/100))</td>
          <td class="numeric">&pound;@if(result.summaryResult.isACA) {@(currencyFormatter.format(result.summaryResult.availableAAAWithCCF/100))}else{@(currencyFormatter.format(result.summaryResult.availableAAWithCCF/100))}
          </td>
       </tr>
      }
    }
       </tbody>
      </table>
@if(year2015Tax > 0 || tax > 0) {
  <div class="panel panel-indent"><p>@Html(Messages("paac.results.p3"))</p></div>
}
    }
  }
}
   } @* End of mpaaPresent *@
  } @* End of sortedResults *@
} @* End of currencyFormatter *@
  <a class="button" href="start" style="margin-top:50px;" data-journey-click="paac:click:start_again">@Messages("paac.results.link.new")</a>
}